apiVersion: batch/v1
kind: Job
metadata:
  name: audit-log-verification
  namespace: audit-test
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: audit-test-runner
      containers:
      - name: verifier
        image: alpine:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "=== Audit Log Verification ==="
          echo ""
          echo "This job simulates checking if audit logs are working."
          echo ""
          echo "Manual verification steps required:"
          echo "1. SSH to control plane node"
          echo "2. Check if audit logs exist:"
          echo "   ls -la /var/log/kubernetes/audit*.log"
          echo ""
          echo "3. Check recent audit entries:"
          echo "   sudo tail -n 20 /var/log/kubernetes/audit.log | grep audit-test"
          echo ""
          echo "4. Verify audit policy is loaded:"
          echo "   kubectl get pods -n kube-system -l component=kube-apiserver -o json | grep audit"
          echo ""
          echo "Expected results:"
          echo "- Audit logs should exist"
          echo "- Should see entries for 'audit-test' namespace"
          echo "- kube-apiserver should have audit arguments"
          echo ""
          sleep 30
          echo "Verification complete"
      restartPolicy: Never
  backoffLimit: 0