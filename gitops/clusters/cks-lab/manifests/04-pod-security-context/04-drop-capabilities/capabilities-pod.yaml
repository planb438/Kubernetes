apiVersion: v1
kind: Pod
metadata:
  name: minimal-capabilities-pod
  namespace: pod-security-lab
  annotations:
    cks.exercise: "04-pod-security-context"
    cks.section: "04-drop-capabilities"
spec:
  securityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
  containers:
  - name: app
    image: nginxinc/nginx-unprivileged:alpine
    securityContext:
      capabilities:
        drop: ["ALL"]  # Drop ALL capabilities first
        add: ["NET_BIND_SERVICE"]  # Then add only what's needed
      allowPrivilegeEscalation: false
    ports:
    - containerPort: 80
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: capabilities-reference
  namespace: pod-security-lab
data:
  dangerous-caps.md: |
    # Dangerous Linux Capabilities
    
    ## HIGH RISK (Never allow):
    - CAP_SYS_ADMIN: Administrative operations
    - CAP_SYS_MODULE: Insert/remove kernel modules
    - CAP_SYS_RAWIO: Raw I/O port access
    - CAP_SYS_PTRACE: Debug processes
    
    ## MEDIUM RISK (Use cautiously):
    - CAP_NET_ADMIN: Network configuration
    - CAP_NET_RAW: Raw sockets (ping, traceroute)
    - CAP_SYS_CHROOT: Change root directory
    
    ## LOW RISK (Typically safe):
    - CAP_NET_BIND_SERVICE: Bind to ports < 1024
    - CAP_DAC_OVERRIDE: Bypass file permission checks
    
    ## Best Practice:
    1. Drop ALL capabilities
    2. Add back ONLY what's absolutely necessary
    3. Document why each capability is needed