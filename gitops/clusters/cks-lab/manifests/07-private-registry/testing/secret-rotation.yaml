apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-rotation-test
  namespace: private-registry-lab
spec:
  schedule: "0 0 * * 0"  # Weekly
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: rotator
            image: bitnami/kubectl:latest
            command: ["/bin/sh", "-c"]
            args:
            - |
              echo "=== Testing Secret Rotation ==="
              echo ""
              
              # Simulate secret rotation
              echo "1. Creating new image pull secret..."
              NEW_SECRET="new-regcred-$(date +%s)"
              
              # In production, this would fetch new credentials from vault
              echo "2. Updating ServiceAccount..."
              echo "3. Testing deployment with new secret..."
              echo "4. Rolling update if successful..."
              echo "5. Deleting old secret..."
              
              echo ""
              echo "=== Rotation Test Complete ==="