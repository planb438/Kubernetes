# Docker Hub Secret (Using ExternalSecrets Operator - RECOMMENDED)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: dockerhub-pull-secret
  namespace: private-registry-lab
  annotations:
    cks.exercise: "07-private-registry"
    cks.registry: "docker-hub"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: dockerhub-regcred
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      engineVersion: 2
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "https://index.docker.io/v1/": {
                "username": "{{ .username }}",
                "password": "{{ .password }}",
                "email": "{{ .email }}",
                "auth": "{{ printf \"%s:%s\" .username .password | b64enc }}"
              }
            }
          }
  data:
  - secretKey: username
    remoteRef:
      key: secrets/dockerhub
      property: username
  - secretKey: password
    remoteRef:
      key: secrets/dockerhub
      property: password
  - secretKey: email
    remoteRef:
      key: secrets/dockerhub
      property: email
---
# GitHub Container Registry (GHCR) Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: ghcr-pull-secret
  namespace: private-registry-lab
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
  target:
    name: ghcr-regcred
    template:
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "ghcr.io": {
                "auth": "{{ .token | b64enc }}"
              }
            }
          }
  data:
  - secretKey: token
    remoteRef:
      key: secrets/ghcr
      property: token
---
# AWS ECR Secret (Using IAM Roles)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: ecr-pull-secret
  namespace: private-registry-lab
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secret-store
  target:
    name: ecr-regcred
    template:
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "{{ .account }}.dkr.ecr.{{ .region }}.amazonaws.com": {
                "username": "AWS",
                "password": "{{ .token }}",
                "auth": "{{ printf \"%s:%s\" \"AWS\" .token | b64enc }}"
              }
            }
          }
  data:
  - secretKey: account
    remoteRef:
      key: aws/ecr
      property: account_id
  - secretKey: region
    remoteRef:
      key: aws/ecr
      property: region
  - secretKey: token
    remoteRef:
      key: aws/ecr
      property: auth_token