# falco-rules-basic.yaml
# Basic security rules for Falco

apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-rules-basic
  namespace: falco-system
data:
  falco_rules.local.yaml: |
    # Custom rules for basic security monitoring
    
    - rule: Terminal shell in container
      desc: A shell was used as the entrypoint/exec point into a container
      condition: >
        container.id != host and
        proc.name = bash
      output: >
        Shell run in container (user=%user.name command=%proc.cmdline container_id=%container.id
        container_name=%container.name image=%container.image.repository:%container.image.tag)
      priority: WARNING
      tags: [container, shell, mitre_execution]
    
    - rule: Unexpected packet socket created
      desc: A packet socket was created by a program outside of system management
      condition: >
        evt.type = socket and
        evt.arg[0] = SOCK_RAW and
        evt.arg[1] = AF_PACKET and
        not proc.name in (systemd, NetworkManager, dhclient, wpa_supplicant)
      output: >
        Unexpected packet socket created (user=%user.name command=%proc.cmdline
        container_id=%container.id image=%container.image.repository)
      priority: WARNING
      tags: [network, mitre_discovery]
    
    - rule: Write below binary dir
      desc: an attempt to write to any file below a set of binary directories
      condition: >
        bin_dir and evt.dir = < and open_write and
        not package_mgmt_procs and not coreos_ignition_writer and
        not python_running_get_pip and not python_running_ms_oms and
        not user_known_write_below_binary_dir_activities
      output: >
        File below a known binary directory opened for writing
        (user=%user.name command=%proc.cmdline file=%fd.name parent=%proc.pname
        pcmdline=%proc.pcmdline container_id=%container.id image=%container.image.repository)
      priority: ERROR
      tags: [filesystem, mitre_persistence, mitre_defense_evasion]
    
    - rule: Launch Suspicious Network Tool in Container
      desc: Detect network scanning or suspicious network tools running in containers
      condition: >
        container.id != host and
        proc.name in (nmap, masscan, hping, netcat, nc, tcpdump, wireshark, tshark)
      output: >
        Suspicious network tool run in container
        (user=%user.name command=%proc.cmdline container_id=%container.id
        image=%container.image.repository:%container.image.tag)
      priority: WARNING
      tags: [network, container, mitre_discovery]
    
    - rule: Crypto Miner Detection
      desc: Detect cryptocurrency mining activity
      condition: >
        spawned_process and
        (proc.name in (xmrig, cpuminer, ccminer, ethminer, minerd) or
         proc.cmdline contains "cryptonight" or
         proc.cmdline contains "stratum+tcp")
      output: >
        Possible crypto mining activity detected
        (user=%user.name command=%proc.cmdline pid=%proc.pid container_id=%container.id)
      priority: CRITICAL
      tags: [crypto, mining, mitre_execution]