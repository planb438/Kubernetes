apiVersion: batch/v1
kind: Job
metadata:
  name: task-02-verification
  namespace: mock-exam-system
  annotations:
    task: "02"
    points: "20"
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: exam-verifier
      containers:
      - name: verifier
        image: bitnami/kubectl:latest
        command: ["/bin/bash", "-c"]
        args:
        - |
          echo "=== Task 2 Verification: Audit Logging ==="
          echo ""
          
          TOTAL_POINTS=0
          
          # Check 1: Finance namespace exists (2 points)
          echo "1. Checking 'finance' namespace..."
          if kubectl get namespace finance >/dev/null 2>&1; then
            echo "   ✓ Namespace exists"
            TOTAL_POINTS=$((TOTAL_POINTS + 2))
          else
            echo "   ✗ Namespace missing"
          fi
          
          # Check 2: Test secret exists (3 points)
          echo ""
          echo "2. Checking test secret..."
          if kubectl get secret audit-test-secret -n finance >/dev/null 2>&1; then
            echo "   ✓ Secret exists"
            TOTAL_POINTS=$((TOTAL_POINTS + 3))
          else
            echo "   ✗ Secret missing"
          fi
          
          # Check 3: Audit policy ConfigMap exists (5 points)
          echo ""
          echo "3. Checking audit policy..."
          if kubectl get configmap finance-audit-policy -n kube-system >/dev/null 2>&1; then
            echo "   ✓ Audit policy ConfigMap exists"
            POLICY_CONTENT=$(kubectl get configmap finance-audit-policy -n kube-system -o jsonpath='{.data.audit-policy\.yaml}')
            
            # Check for required rules
            if echo "$POLICY_CONTENT" | grep -q "level: Request" && \
               echo "$POLICY_CONTENT" | grep -q "resources:.*secrets" && \
               echo "$POLICY_CONTENT" | grep -q "namespaces:.*finance"; then
              echo "   ✓ Has Request level for secrets in finance namespace"
            fi
            
            if echo "$POLICY_CONTENT" | grep -q "level: Metadata" && \
               echo "$POLICY_CONTENT" | grep -q "resources:.*configmaps"; then
              echo "   ✓ Has Metadata level for configmaps"
            fi
            
            if echo "$POLICY_CONTENT" | grep -q "level: None" && \
               echo "$POLICY_CONTENT" | grep -q "verbs:.*get"; then
              echo "   ✓ Excludes get operations (noise reduction)"
            fi
            
            TOTAL_POINTS=$((TOTAL_POINTS + 5))
          else
            echo "   ✗ Audit policy missing"
          fi
          
          # Check 4: Simulated audit event generation (5 points)
          echo ""
          echo "4. Testing audit event generation..."
          
          # Create a pod that will access the secret (simulating audit event)
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Pod
          metadata:
            name: audit-test-pod
            namespace: finance
          spec:
            serviceAccountName: default
            containers:
            - name: test
              image: alpine
              command: ["sh", "-c", "echo 'Accessing secret...'; sleep 5"]
          EOF
          
          # Wait for pod to be ready
          sleep 3
          
          # Simulate secret access
          kubectl exec -n finance audit-test-pod -- sh -c "echo 'Simulating secret access audit event'" >/dev/null 2>&1
          
          if [[ $? -eq 0 ]]; then
            echo "   ✓ Audit event simulation successful"
            TOTAL_POINTS=$((TOTAL_POINTS + 5))
          else
            echo "   ✗ Failed to generate audit event"
          fi
          
          # Check 5: Cleanup verification (5 points)
          echo ""
          echo "5. Checking proper approach..."
          
          # Verify no direct node modifications were made
          NODE_MODIFICATION=false
          
          # Check for any suspicious node-level commands in cluster
          # (This is simulated for exam purposes)
          echo "   ✓ No direct modification of kube-apiserver static pod"
          echo "   ✓ Used Kubernetes-native approach"
          echo "   ✓ Non-disruptive implementation"
          
          TOTAL_POINTS=$((TOTAL_POINTS + 5))
          
          # Cleanup
          kubectl delete pod audit-test-pod -n finance --ignore-not-found
          
          echo ""
          echo "=== Verification Complete ==="
          echo "Total Points: $TOTAL_POINTS/20"
          echo ""
          
          # Store result
          echo "{\"task\": \"02\", \"points\": $TOTAL_POINTS, \"max_points\": 20, \"timestamp\": \"$(date -Iseconds)\"}" > /tmp/result.json
          kubectl create configmap task-02-result --from-file=/tmp/result.json -n mock-exam-system --dry-run=client -o yaml | kubectl apply -f -
          
        restartPolicy: Never
  backoffLimit: 0