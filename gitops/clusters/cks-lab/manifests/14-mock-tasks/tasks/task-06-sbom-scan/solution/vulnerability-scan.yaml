apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: check-vulnerabilities
  annotations:
    policies.kyverno.io/title: Check Image Vulnerabilities
    policies.kyverno.io/category: Supply Chain Security
    policies.kyverno.io/severity: high
spec:
  validationFailureAction: Enforce
  background: true
  rules:
  - name: check-critical-vulnerabilities
    match:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment
          - StatefulSet
          - DaemonSet
          - Job
          - CronJob
        namespaces:
        - production
        - staging
    context:
    - name: vulnerabilityDatabase
      configMap:
        name: vulnerability-database
        namespace: sbom-system
    validate:
      message: "Image contains critical vulnerabilities that must be remediated before deployment"
      foreach:
      - list: "request.object.spec.containers"
        context:
        - name: imageScan
          apiCall:
            urlPath: "/apis/external.snapshot.com/v1"
            jmesPath: "scanResults"
            method: POST
            data:
              image: "{{ element.image }}"
        deny:
          conditions:
            any:
            - key: "{{ imageScan.criticalCount }}"
              operator: GreaterThan
              value: 0
            - key: "{{ imageScan.highCount }}"
              operator: GreaterThan
              value: 5
  
  - name: require-sbom
    match:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment
        namespaces:
        - production
    context:
    - name: sbomCheck
      apiCall:
        urlPath: "/api/v1/namespaces/sbom-system/configmaps"
        jmesPath: "items[?metadata.name.contains('sbom-')].metadata.name | [0]"
    validate:
      message: "SBOM must exist for production images. Run SBOM generation pipeline first."
      deny:
        conditions:
          all:
          - key: "{{ sbomCheck }}"
            operator: Equals
            value: ""
  
  - name: enforce-scan-frequency
    match:
      any:
      - resources:
          kinds:
          - Deployment
        namespaces:
        - production
    context:
    - name: lastScan
      apiCall:
        urlPath: "/api/v1/namespaces/sbom-system/configmaps"
        jmesPath: "items[?metadata.name.contains('sbom-daily-')].metadata.name | sort(@) | [-1]"
    validate:
      message: "Image must have been scanned within the last 24 hours"
      deny:
        conditions:
          all:
          - key: "{{ lastScan }}"
            operator: NotEquals
            value: "sbom-daily-$(date +%Y%m%d)"
---
# Admission webhook for real-time scanning
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: vulnerability-scan-webhook
  labels:
    app: vulnerability-scanner
webhooks:
- name: vulnerability-scan.company.com
  admissionReviewVersions: ["v1"]
  clientConfig:
    service:
      name: vulnerability-scanner
      namespace: sbom-system
      path: "/validate"
      port: 443
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: ["*"]
    apiVersions: ["*"]
    resources: ["pods", "deployments"]
  failurePolicy: Fail
  sideEffects: None
  timeoutSeconds: 10
  namespaceSelector:
    matchExpressions:
    - key: security-scan-enabled
      operator: In
      values: ["true"]