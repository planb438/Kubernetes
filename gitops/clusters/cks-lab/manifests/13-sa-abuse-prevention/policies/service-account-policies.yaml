apiVersion: v1
kind: ConfigMap
metadata:
  name: service-account-policies
  namespace: sa-security-system
data:
  policies.yaml: |
    # Service Account Security Policies
    
    # Policy 1: Default Service Account Restrictions
    - name: disable-default-sa-automount
      description: Disable automatic token mounting for default service accounts
      rules:
        - resource: ServiceAccount
          selector: metadata.name=default
          actions:
            - set: automountServiceAccountToken=false
    
    # Policy 2: Service Account Naming Convention
    - name: sa-naming-convention
      description: Enforce naming conventions for service accounts
      rules:
        - resource: ServiceAccount
          validation:
            regex: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
            max_length: 63
            disallowed_patterns: ["default", "admin", "root", "system"]
    
    # Policy 3: Token Mounting Restrictions
    - name: restrict-token-mounting
      description: Restrict service account token mounting
      rules:
        - resource: Pod
          validation:
            required_fields:
              - spec.automountServiceAccountToken
            allowed_values:
              spec.automountServiceAccountToken: [false]
          exceptions:
            - namespace: kube-system
            - namespace: default
              service_account: "cluster-admin"
    
    # Policy 4: Service Account Usage Limits
    - name: sa-usage-limits
      description: Limit service account usage
      rules:
        - max_pods_per_sa: 10
        - max_namespaces_per_sa: 3
        - token_max_age: "24h"
    
    # Policy 5: RBAC Association Requirements
    - name: rbac-association
      description: Require RBAC bindings for service accounts
      rules:
        - service_accounts_must_have_bindings: true
        - binding_types: ["RoleBinding", "ClusterRoleBinding"]
        - max_cluster_roles_per_sa: 2
    
  best-practices.md: |
    # Service Account Security Best Practices
    
    1. **Minimize Token Mounting**
       - Set `automountServiceAccountToken: false` by default
       - Only mount tokens when absolutely necessary
       - Use projected service account tokens with expiration
    
    2. **Principle of Least Privilege**
       - Create dedicated service accounts for each workload
       - Assign minimal required permissions
       - Use namespaced roles instead of cluster roles
    
    3. **Regular Auditing**
       - Review service account permissions regularly
       - Monitor token usage and access patterns
       - Remove unused service accounts
    
    4. **Token Management**
       - Use short-lived tokens when possible
       - Implement token rotation
       - Monitor for token leakage
    
    5. **Namespace Segregation**
       - Isolate workloads in dedicated namespaces
       - Limit service account cross-namespace access
       - Use network policies to restrict communication