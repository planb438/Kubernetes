apiVersion: batch/v1
kind: Job
metadata:
  name: vulnerability-scanner
  namespace: sbom-system
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      serviceAccountName: vuln-checker
      containers:
      - name: trivy
        image: aquasec/trivy:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "=== Vulnerability Scanning Demo ==="
          echo ""
          
          # Pull and scan vulnerable demo image
          echo "1. Scanning vulnerable demo image..."
          echo ""
          
          # Build vulnerable image
          cat > /tmp/Dockerfile.vuln << 'EOF'
          FROM python:3.8-slim
          RUN pip install flask==0.12.1 requests==2.20.0 django==1.11.29
          COPY app.py /app.py
          CMD ["python", "/app.py"]
          EOF
          
          cat > /tmp/app.py << 'EOF'
          from flask import Flask
          app = Flask(__name__)
          @app.route('/')
          def hello():
              return "Vulnerable app"
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          
          echo "Building vulnerable image..."
          docker build -f /tmp/Dockerfile.vuln -t vulnerable-demo:latest /tmp/
          
          echo ""
          echo "Running Trivy scan..."
          echo "=== Trivy Results ==="
          trivy image vulnerable-demo:latest --severity HIGH,CRITICAL --format table
          
          echo ""
          echo "2. Scanning secure demo image..."
          echo ""
          
          # Build secure image
          cat > /tmp/Dockerfile.secure << 'EOF'
          FROM python:3.11-slim
          RUN pip install flask==2.3.3 requests==2.31.0
          COPY app.py /app.py
          CMD ["python", "/app.py"]
          EOF
          
          echo "Building secure image..."
          docker build -f /tmp/Dockerfile.secure -t secure-demo:latest /tmp/
          
          echo ""
          echo "=== Trivy Results (Secure) ==="
          trivy image secure-demo:latest --severity HIGH,CRITICAL --format table
          
          echo ""
          echo "3. Comparing results..."
          echo ""
          echo "Vulnerable image should show multiple HIGH/CRITICAL vulnerabilities"
          echo "Secure image should show minimal or no HIGH/CRITICAL vulnerabilities"
          echo ""
          echo "Scan complete!"
        securityContext:
          privileged: true
          capabilities:
            add: ["DAC_OVERRIDE"]
      restartPolicy: Never