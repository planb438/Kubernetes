apiVersion: apps/v1
kind: Deployment
metadata:
  name: image-admission-controller
  namespace: sbom-system
  labels:
    app: image-admission-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: image-admission-controller
  template:
    metadata:
      labels:
        app: image-admission-controller
    spec:
      serviceAccountName: sbom-scanner
      containers:
      - name: admission-webhook
        image: ghcr.io/sigstore/cosign:v2.0.0
        command:
        - /bin/sh
        - -c
        - |
          # Simple admission webhook for image validation
          echo "Starting admission webhook..."
          echo "Webhook will validate images before they are deployed"
          
          # Create simple HTTP server
          python3 -c "
          from http.server import HTTPServer, BaseHTTPRequestHandler
          import json
          import subprocess
          import sys
          
          class AdmissionHandler(BaseHTTPRequestHandler):
              def do_POST(self):
                  content_length = int(self.headers['Content-Length'])
                  post_data = self.read(content_length)
                  
                  try:
                      request = json.loads(post_data)
                      admission_review = request.get('request', {})
                      
                      # Extract image from admission request
                      image = self.extract_image(admission_review)
                      
                      if image:
                          # Validate image
                          allowed, message = self.validate_image(image)
                          
                          response = {
                              'apiVersion': 'admission.k8s.io/v1',
                              'kind': 'AdmissionReview',
                              'response': {
                                  'uid': admission_review.get('uid', ''),
                                  'allowed': allowed,
                                  'status': {
                                      'message': message
                                  }
                              }
                          }
                      else:
                          response = {
                              'apiVersion': 'admission.k8s.io/v1',
                              'kind': 'AdmissionReview',
                              'response': {
                                  'uid': admission_review.get('uid', ''),
                                  'allowed': True,
                                  'status': {'message': 'No image found in request'}
                              }
                          }
                      
                      self.send_response(200)
                      self.send_header('Content-Type', 'application/json')
                      self.end_headers()
                      self.wfile.write(json.dumps(response).encode())
                      
                  except Exception as e:
                      self.send_error(500, str(e))
              
              def extract_image(self, admission_review):
                  # Simplified image extraction
                  # In production, parse the full admission request
                  return 'demo-image:latest'
              
              def validate_image(self, image):
                  # Simple validation logic
                  # In production, integrate with Trivy, Grype, Cosign, etc.
                  print(f'Validating image: {image}')
                  
                  # Check for known bad images
                  bad_patterns = ['latest', ':vulnerable', 'test']
                  for pattern in bad_patterns:
                      if pattern in image.lower():
                          return False, f'Image rejected: contains {pattern}'
                  
                  return True, 'Image accepted'
              
              def log_message(self, format, *args):
                  pass
          
          server = HTTPServer(('0.0.0.0', 8443), AdmissionHandler)
          print('Admission webhook listening on port 8443')
          server.serve_forever()
          "
        ports:
        - containerPort: 8443
          name: https
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8443
            scheme: HTTPS
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8443
            scheme: HTTPS
          initialDelaySeconds: 5
          periodSeconds: 5
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
---
apiVersion: v1
kind: Service
metadata:
  name: image-admission-controller
  namespace: sbom-system
spec:
  selector:
    app: image-admission-controller
  ports:
  - port: 8443
    targetPort: https
    name: https