# GitHub Actions workflow for signing (ConfigMap for documentation)
apiVersion: v1
kind: ConfigMap
metadata:
  name: github-actions-signing-workflow
  namespace: supply-chain-lab
data:
  sign-images.yml: |
    # .github/workflows/sign-images.yml
    name: Sign Container Images
    
    on:
      push:
        branches: [ main ]
        tags: [ 'v*' ]
    
    jobs:
      build-and-sign:
        runs-on: ubuntu-latest
        permissions:
          id-token: write  # Required for keyless signing
          contents: read
        
        steps:
        - uses: actions/checkout@v3
        
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v2
        
        - name: Log in to GitHub Container Registry
          uses: docker/login-action@v2
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}
        
        - name: Build and push Docker image
          uses: docker/build-push-action@v4
          with:
            push: true
            tags: |
              ghcr.io/${{ github.repository }}:${{ github.sha }}
              ghcr.io/${{ github.repository }}:latest
            cache-from: type=gha
            cache-to: type=gha,mode=max
        
        - name: Install Cosign
          uses: sigstore/cosign-installer@main
        
        - name: Sign container image (Keyless)
          run: |
            cosign sign \
              --yes \
              ghcr.io/${{ github.repository }}:${{ github.sha }}
        
        - name: Generate and sign SBOM
          run: |
            # Generate SBOM
            cosign attest \
              --predicate-type https://cyclonedx.org/bom \
              --yes \
              ghcr.io/${{ github.repository }}:${{ github.sha }}
        
        - name: Verify signatures
          run: |
            cosign verify \
              --certificate-identity-regexp ".*" \
              --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
              ghcr.io/${{ github.repository }}:${{ github.sha }}